<!DOCTYPE html>
<html><head>
	<title>mjpeg-relay example</title>
	<script type="text/javascript" src="functions.js"></script>
</head>
<body>
	<canvas id="canvas"></canvas>
	<script>
		var c = document.getElementById("canvas");
		var ctx = c.getContext("2d");
		var last_req_time = 0;
		var last_draw_time = 0;

		var url = 'ws://'+document.location.hostname + ':8081';
		var ws = ws_client(url, 3000, function(evt) {
			//evt=null is onopen event
			if (evt === null) {
				req_feed();
				return;
			}

			let begin_time = Date.now();
			let image = new Image();
			image.onload = function () {
				ctx.canvas.width = this.width;
				ctx.canvas.height = this.height;
				ctx.drawImage(this, 0, 0);
				last_draw_time = Date.now() - begin_time;
				req_feed();
			};

			let bytes = new Uint8Array(evt.data);
			image.src = 'data:image/png;base64,'+encode(bytes);
		});

		function req_feed(req_time, draw_time) {
			let req_data = {
				handler: 'mjpeg',
				userId: userid(),
				req_time: last_req_time, 
				draw_time: last_draw_time
			};

			last_req_time = Date.now();
			ws.send(JSON.stringify(req_data));
		}
	</script>
</body>
</html>
